#!/usr/bin/env bash
# Generates the bindings for the pmdsky-debug headers.
# Note that bindgen needs to be in the path and pmdsky-debug needs to be checkout out.
set -e

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

bindgen \
  --raw-line '//! This module contains the "raw" functions and types from the game. They are generated by bindgen. It is generally recommended to try and use [`crate::api`] instead.' \
  --raw-line "//!" \
  --raw-line "//! For the documentation, see the symbol YAML files of pmdsky-debug at <https://github.com/UsernameFodder/pmdsky-debug/tree/master/symbols>." \
  --raw-line "#![allow(non_upper_case_globals)]" \
  --raw-line "#![allow(non_camel_case_types)]" \
  --raw-line "#![allow(non_snake_case)]" \
  --raw-line "#![allow(clippy::missing_safety_doc)]" \
  --raw-line "#![allow(clippy::useless_transmute)]" \
  --ctypes-prefix "crate::ctypes" \
  --use-core \
  --no-layout-tests \
  --no-derive-copy \
  --no-derive-debug \
  --default-enum-style moduleconsts \
  --newtype-enum ability_id \
  --newtype-enum dungeon_id \
  --newtype-enum dungeon_group_id \
  --newtype-enum exclusive_item_effect_id \
  --newtype-enum fixed_room_id \
  --newtype-enum iq_group_id \
  --newtype-enum iq_skill_id \
  --newtype-enum item_id \
  --newtype-enum monster_id \
  --newtype-enum move_id \
  --newtype-enum script_opcode_id \
  --newtype-enum script_var_id \
  --newtype-enum special_process_id \
  --newtype-enum type_id \
  $SCRIPT_DIR/include.h \
  -- \
  -target armv5te-none-eabi \
  > $SCRIPT_DIR/src/ffi.rs

# Make fields of newtype enums private.
sed_inplace() {
    # sed -i isn't portable
    sed "$1" "$2" > "$2.tmp"
    mv "$2.tmp" "$2"
}

sed_inplace 's/pub struct ability_id(pub /pub struct ability_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct dungeon_id(pub /pub struct dungeon_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct dungeon_group_id(pub /pub struct dungeon_group_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct exclusive_item_effect_id(pub /pub struct exclusive_item_effect_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct fixed_room_id(pub /pub struct fixed_room_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct iq_group_id(pub /pub struct iq_group_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct iq_skill_id(pub /pub struct iq_skill_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct item_id(pub /pub struct item_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct monster_id(pub /pub struct monster_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct move_id(pub /pub struct move_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct script_opcode_id(pub /pub struct script_opcode_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct script_var_id(pub /pub struct script_var_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct special_process_id(pub /pub struct special_process_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
sed_inplace 's/pub struct type_id(pub /pub struct type_id(pub(crate) /g' $SCRIPT_DIR/src/ffi.rs
